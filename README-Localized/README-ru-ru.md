# <a name="word-style-checking-addin-built-on-angular-2"></a>Надстройка Word для проверки стиля на Angular 2

Узнайте, как создать надстройку, которая использует API `LocationRelation` и `compareLocationWith` (API JavaScript для Word) для поиска и замены строк, пропуская диапазоны на основе их расположения. Надстройка создана на платформе Angular 2. Из этого примера вы также узнаете, как использовать [ шаблоны оформления надстроек Office](https://github.com/OfficeDev/Office-Add-in-UX-Design-Patterns-Code). 

## <a name="table-of-contents"></a>Содержание
* [История изменений](#change-history)
* [Необходимые компоненты](#prerequisites)
* [Настройка проекта](#configure-the-project)
* [Развертывание надстройки](#deploy-the-add-in)
* [Запуск проекта](#run-the-project)
* [Запуск надстройки](#start-the-add-in)
* [Тестирование надстройки](#test-the-add-in)
* [Изменение параметров надстройки](#change-the-settings-of-the-add-in)
* [Разбор кода](#understand-the-code)
* [Вопросы и комментарии](#questions-and-comments)
* [Дополнительные ресурсы](#additional-resources)

## <a name="change-history"></a>История изменений

1 августа 2016 г.

* Исходная версия.

15 сентября – 17 октября 2016 г.

* Незначительные изменения.

## <a name="prerequisites"></a>Необходимые компоненты

* Word 2016 для Windows, сборка 16.0.6727.1000 или более новая.
* [Node и npm.](https://nodejs.org/en/) В этом проекте npm используется как диспетчер пакетов и как средство запуска приложений. В качестве веб-сервера используется Lite Server, встроенный в npm. Надстройка размещается на нем во время разработки, чтобы ее можно было быстро настроить и запустить. Вы можете использовать другое средство запуска задач или другой веб-сервер.
* [Git Bash](https://git-scm.com/downloads) (или другой клиент git).

## <a name="configure-the-project"></a>Настройка проекта

В папке проекта выполните следующие команды в консоли git bash:

1. ```git clone {URL of this repo}```, чтобы клонировать этот репозиторий на локальный компьютер.
2. ```npm install```, чтобы установить все детализированные зависимости в файл package.json.
3. ```bash gen-cert.sh```, чтобы создать сертификат, необходимый для запуска этого примера. 

Сделайте сертификат доверенным корневым центром. Для этого на компьютере с Windows выполните указанные ниже действия.

1. В папке репозитория на локальном компьютере дважды щелкните файл ca.crt и выберите элемент **Установить сертификат**. 
2. Выберите **Локальный компьютер** и нажмите кнопку **Далее**, чтобы продолжить. 
3. Выберите **Поместить все сертификаты в следующее хранилище** и нажмите кнопку **Обзор**.
4. Выберите **Доверенные корневые центры сертификации** и нажмите кнопку **ОК**. 
5. Нажмите кнопку **Далее**, а затем кнопку **Готово**. 

## <a name="deploy-the-addin"></a>Развертывание надстройки

Теперь необходимо сообщить Microsoft Word, где находится эта надстройка.

1. Создайте сетевую папку или [предоставьте общий доступ к папке](https://technet.microsoft.com/en-us/library/cc770880.aspx).
2. Поместите копию файла манифеста Word-Add-in-Angular2-StyleChecker.xml из корня проекта в общую папку.
3. Запустите Word и откройте документ.
4. Перейдите на вкладку **Файл**, а затем выберите **Параметры**.
5. Выберите **Центр управления безопасностью**, а затем нажмите кнопку **Параметры центра управления безопасностью**.
6. Выберите пункт **Доверенные каталоги приложений**.
7. В поле **URL-адрес каталога** введите сетевой путь к общей папке с файлом Word-Add-in-Angular2-StyleChecker.xml и выберите **Добавить каталог**.
8. Установите флажок **Показать в меню** и нажмите кнопку **ОК**.
9. Появится сообщение, информирующее о том, что параметры будут применены при следующем запуске Microsoft Office. Закройте Word.

## <a name="run-the-project"></a>Запуск проекта

1. Откройте командное окно узла в папке проекта и запустите ```npm start``` для запуска веб-службы. Не закрывайте командное окно.
2. Откройте Internet Explorer или Edge и введите ```https://localhost:3000``` в адресной строке. Если вы не получите никаких предупреждений о сертификате, закройте браузер и перейдите к приведенному ниже разделу под названием **Запуск надстройки**. Если вы получите предупреждение, что сертификат не является доверенным, выполните указанные ниже действия.
3. Несмотря на предупреждение в браузере отобразится ссылка на открытие страницы. Откройте ее.
4. После открытия страницы в адресной строке появится оповещение об ошибке сертификата красного цвета. Дважды щелкните это оповещение.
5. Выберите элемент **Просмотр сертификата**.
5. Нажмите **Установить сертификат**.
4. Выберите **Локальный компьютер** и нажмите кнопку **Далее**, чтобы продолжить. 
3. Выберите **Поместить все сертификаты в следующее хранилище** и нажмите кнопку **Обзор**.
4. Выберите **Доверенные корневые центры сертификации** и нажмите кнопку **ОК**. 
5. Выберите **Далее**, а затем **Готово**.
6. Закройте браузер.

## <a name="start-the-addin"></a>Запуск надстройки

1. Перезапустите Word и откройте документ Word.
2. На вкладке **Вставка** в Word 2016 выберите **Мои надстройки**.
3. Перейдите на вкладку **ОБЩАЯ ПАПКА**.
4. Выберите элемент **Style Checker** и нажмите кнопку **ОК**.
5. Если ваша версия Word поддерживает команды надстроек, то в пользовательском интерфейсе отобразятся сведения о том, что надстройка загружена.
6. На вкладке "Главная" появится новая группа **Style Checker** с кнопкой **Показать** и значком в виде синего карандаша. Нажмите эту кнопку, и откроется страница с инструкциями.

 > Примечание. Если ваша версия Word не поддерживает команды надстроек, то надстройка загрузится в области задач.

## <a name="test-the-addin"></a>Тестирование надстройки

1. Просмотрите инструкции, а затем нажмите кнопку **Get Started** (Начать работу).
2. Когда откроется страница **Find and Replace** (Поиск и замена), вверху вы увидите панель команд с кнопкой меню. Нажмите кнопку, чтобы открыть меню.
3. Выберите **Insert sample content** (Вставить образец содержимого). Нажмите кнопку еще раз, чтобы закрыть меню. Теперь документ содержит неформатированный текст о надстройках Office, в том числе вымышленную цитату. В тексте и анонимной цитате для обозначения надстройки Office используется аббревиатура "OAI".
4. В поле **Find** (Поиск) введите "OAI". 
5. В поле **Replace** (Замена) введите "Надстройка Office".
6. Для абзаца с цитатой изменение ***не*** требуется, поэтому введите число **2** в поле **Skip Paragraphs** (Пропустить абзацы). Это номер абзаца с отчетом от нуля.
7. Нажмите кнопку **Replace** (Заменить). Все экземпляры "OAI", кроме экземпляра в пропущенном абзаце, будут заменены.
8. Поэкспериментируйте с поиском
9. и заменой других строк.

 > Примечание. В этой версии надстройки в поле **Skip Paragraphs** (Пропустить абзацы) можно ввести только одно число. 

## <a name="change-the-settings-of-the-addin"></a>Изменение параметров надстройки

1. Откройте меню на панели команд еще раз и выберите **Settings** (Параметры). 
2. На странице **Settings** (Параметры) вы увидите, что по умолчанию страница с инструкциями открывается при каждом запуске надстройки. Выберите настройку, при которой страница с инструкциями отображается только при первом запуске надстройки. 
3. Закройте область задач и повторно запустите надстройку, нажав кнопку **Показать**. Откроется страница **Find and Replace** (Поиск и замена), а не страница с инструкциями. 
4. Снова перейдите на страницу **Settings** (Параметры). Вы можете нажать кнопку **Show Instructions** (Показать инструкции), чтобы открыть страницу с инструкциями, или вернуться к настройке, при которой страница с инструкциями открывается при каждом запуске надстройки.

## <a name="understand-the-code"></a>Разбор кода

Весь код, который использует API JavaScript для Office и Word, находится в файле word.document.service.ts. Метод `compareLocationWith()`, который демонстрируется в этом примере, находится в методе `replaceFoundStringsWithExceptions()`. 

Код сначала получает коллекцию всех диапазонов, которые соответствуют условию поиска пользователя. Затем он получает коллекцию всех диапазонов абзацев в документе. 

```js
let foundItems: Word.SearchResultCollection = context.document.body.search(searchString, 
    { matchCase: false, matchWholeWord: true })
    .load();
let paras : Word.ParagraphCollection = context.document.body.paragraphs.load();
```

После загрузки коллекций методом `context.sync()` код создает массив диапазонов абзацев, исключенных пользователем. Обратите внимание, что в метод передается параметр `excludedParagraphs`.

```js
let excludedRanges: Array<Word.Range> = [];
excludedRanges.push(paras.items[excludedParagraphs].getRange('Whole'));
```

Затем код просматривает итерируемые объекты, чтобы определить результаты поиска в исключенных абзацах. Для каждого результата поиска этот факт записывается в объекте `IReplacementCandidate`. Метод `compareLocationWith()` возвращает значение "Inside", если результат поиска находится в исключенном абзаце. Если результат поиска совпадает с исключенным абзацем, возвращается значение "Equal". 

```js
for (let i = 0; i < foundItems.items.length; i++) {
    for (let j = 0; j < excludedRanges.length; j++) {
        replacementCandidates.push({
            range: foundItems.items[i],
            locationRelation: foundItems.items[i].compareLocationWith(excludedRanges[j])
        });
    }
}
```

Потенциальные объекты замены загружаются методом `context.sync()`, а затем код выполняет итерацию по ним, заменяя строки только в неисключенных абзацах.

```js
replacementCandidates.forEach(function (item) {
    switch (item.locationRelation.value) {
        case "Inside":
        case "Equal":
            break;
        default:
            item.range.insertText(replaceString, 'Replace');
    }
});
```

Просмотрите метод `replaceDocumentContent` в том же файле, чтобы узнать, как методы `insertText` и `insertParagraph` Word используются для вставки образцов содержимого в документ.

Просмотрите остальные файлы кода, чтобы узнать, как шаблоны оформления из [кода шаблонов оформления надстроек Office](https://github.com/OfficeDev/Office-Add-in-UX-Design-Patterns-Code) интегрированы в платформу Angular 2.

## <a name="questions-and-comments"></a>Вопросы и комментарии

Мы будем рады узнать ваше мнение об этом примере. Своими мыслями можете поделиться на вкладке *Issues* (Проблемы) этого репозитория.

Общие вопросы о разработке решений для Microsoft Office 365 следует задавать на сайте [Stack Overflow](http://stackoverflow.com/questions/tagged/office-js+API). Если ваш вопрос касается API JavaScript для Office, добавьте к нему теги [office-js] и [API].

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Документация по надстройкам Office](https://msdn.microsoft.com/en-us/library/office/jj220060.aspx)
* [Центр разработки для Office](http://dev.office.com/)
* Другие примеры надстроек Office см. на странице [OfficeDev на Github](https://github.com/officedev).

## <a name="copyright"></a>Авторское право
© Корпорация Майкрософт (Microsoft Corporation), 2016 г. Все права защищены.

